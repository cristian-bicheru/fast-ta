#include <cstdlib>

#include "gtest/gtest.h"
#include "testing_common.h"

extern "C" {
    #include "volume_backend.h"
}

const double ADI_REF_DOUBLE[data_len] = {
        -13076765.60693842, 12799974.04091093, 28386380.57297606, 41694930.63016835,
        61746609.34287685, 46904600.93122686, 30609117.72880282, 40192737.59755313,
        33773369.35110775, 21082023.12627682,-16236162.36408982,-33791774.99042606,
        -15235067.45055062, 12833678.71098193,-2048285.325506005,-11512965.98698881,
        10044219.60505136, 28615076.81713767, 20905678.46208723, 39724099.07673612,
        58578687.56901424, 48114272.56677595, 50814576.52097984, 65519357.87396045,
        69817179.86745577,   44398991.478074, 57378659.94079952, 38380026.90447353,
        17105876.9870113, 12089828.03808418, 17891838.28215479,-7709400.326378409,
        -16105437.94622484, 12646360.50190996, 4526215.774551369, 23660007.86718853,
        36682110.72101243, 23886409.41237269, 24110738.58611237, 17189313.28768239,
        2988580.676358055, 12055770.59940636, 15473255.02913398, 22790448.55958852,
        10872051.21102067, 13207018.85678189, -12286556.5796233,-22999002.45124349,
        -41097022.3444829,-32073690.28793558,-49420483.08733574,-58436307.91250924,
        -72948213.42087872,-63667496.02860186,-52695024.34403051,-48893491.99277312,
        -46944277.65225675,-30481729.79535183, -20832148.9174893,-40421312.29961865,
        -36511186.39605061,-31526471.46333693,-35468525.45749255,-48335769.22010238,
        -33504108.28436309,-52107980.49875249,-29953101.44795274,-13184323.81372621,
        -5461332.471117435,-16156684.81160704,-25612296.81289501, -22854008.0975012,
        -21782404.29835113,-67121591.99351503,-104967720.2839464,-105137894.3300066,
        -144411151.9507743,-127610001.3840518,-100290786.7587326,-74586171.81042355,
        -75082666.44258818, -76942691.1440632,-55398721.51305193,-88908344.33057505,
        -95528468.90528715,-78889713.81794988,-97516253.39143822,-123690843.1280354,
        -123375710.0983788,-125003956.3582996,-157924860.9128053,-148999014.5594651,
        -168378172.9745184,-154963049.1817088,-138865255.6079797,-139971113.9789335,
        -138520191.085595,-124484370.9086868, -113985679.512243,-118142008.6315689,
        -113921064.8545636,-83146044.36829861,-40634113.06676722,-68696775.92488192,
        -71966415.09626952,-54595538.81908458,-38863205.48826118,-14712207.42491591,
        -29093740.3292227,-78845882.59800982,-79283345.67521261,-104706899.3990124,
        -87525801.02389726,-87436596.28503489,-91570010.44717795,-73954722.50411516,
        -102007182.3610702,-123999625.0928076,-96767021.70553586,-71379418.65037413,
        -83714638.20298018,-110620507.6623578,-105143073.6994723,-83188312.34260531,
        -63864302.48195055,-71249728.98244621,-86151330.54115283,-83434420.46511406,
        -77716639.40891221,-70682981.85381162,-54576842.79313631,-69727609.10463528,
        -51896802.40524261,-48711057.91438054,-31773078.03133658, -11446929.0028191,
        -39995087.18457493,-39919125.64573714, -7523958.27017051, 29029743.26200325,
        47530778.68749511, 44860407.89741278, 59353360.55508387, 63591678.55500488,
        78164179.17205304, 95983343.91880012, 98436310.72300744, 119827791.1535859,
        106193877.4789047, 130883919.0522115, 148089236.2716207, 142179700.0579642,
        141712226.039563, 129165453.3274556, 125955085.5285649, 146209930.8555832,
        140114295.7931668, 154712724.2460245, 158042576.6018749, 141408831.1660113,
        168603935.3859633, 165346968.6693976, 180302179.6383712, 202663947.3533409,
        192501146.6327275,   198031742.70871, 212722669.0767262, 232637801.4624879,
        263742097.1832611, 280143437.2036496, 282546057.5150909, 266477276.5321114,
        265484455.9690212, 226179684.7501736, 247647044.5125966, 252137788.6920443,
        274800746.1652372, 259236434.5508555, 283978843.1910954, 308816773.9258732,
        339556552.7652973, 319652275.9671853, 347935460.7933521, 335202029.2090433,
        356882609.0609058, 383323977.3875003, 381255367.3434126, 410509107.6178008,
        377668062.8661962, 365526976.2471439, 385800259.0236186, 420070498.9256507,
        402820233.6995186, 384771868.8132058, 406481382.0362099, 379809638.0335442,
        387154715.2572361, 418439061.4315951, 413843615.1420658, 442918586.3377749,
        401482164.528536, 407696007.6333342,  432871072.195157, 428729527.2950382,
        454979545.0197476, 447678792.0344662, 475015992.0344662, 459613444.9237998,
        487848361.7093996, 489251280.6422549, 496098083.8258923,  523102667.273995,
        536829981.1638866, 528007001.3805696, 512219543.9397142, 523180624.7036644,
        479225929.9609714, 483228719.2626545, 409961459.2501653, 467776682.1516259,
        534199423.0509582,   485225013.17647, 532976829.5515994,  503481490.294028,
        538917324.7944803, 497349911.5616338, 559480244.5127274, 544324572.3429365,
        441893512.0271183, 521174001.4616076, 459241028.5701323, 500190959.4327757,
        536438097.7730482, 497307124.6850163, 407334968.9288564, 447760084.1179636,
        510946116.8737541, 448321416.9904853, 508887912.6682419,  465821815.176362,
        498072119.6712568, 470324652.6096106, 442623999.7740096, 481895036.3840702,
        472969447.8250279, 518720905.6174794, 471433751.0252793, 495777884.4611965,
        504909853.9258048, 533919579.0227008, 571197895.4615048, 582108362.1281717,
        596852362.8429149
};

float ADI_REF_FLOAT[data_len] = {0};

TEST(momentum_backend, ADIDouble) {
    double* out = _ADI_DOUBLE(SAMPLE_HIGH_DOUBLE, SAMPLE_LOW_DOUBLE, SAMPLE_CLOSE_DOUBLE, SAMPLE_VOLUME_DOUBLE, data_len);
    for (int i=0; i<data_len; i++) {
        ASSERT_DOUBLE_EQ(ADI_REF_DOUBLE[i], out[i]);
    }

    free(out);
}

TEST(momentum_backend, ADIFloat) {
    float* out = _ADI_FLOAT(SAMPLE_HIGH_FLOAT, SAMPLE_LOW_FLOAT, SAMPLE_CLOSE_FLOAT, SAMPLE_VOLUME_FLOAT, data_len);
    for (int i=0; i<data_len; i++) {
        ASSERT_NEAR(ADI_REF_FLOAT[i], out[i], get_max_fp_error(ADI_REF_DOUBLE[0]));
    }

    free(out);
}

int main(int argc, char* argv[]) {
    populate_float_arrays();
    for (int i=0; i<data_len; i++) {
        ADI_REF_FLOAT[i] = (float)ADI_REF_DOUBLE[i];
    }
    testing::InitGoogleTest(&argc, argv);
    return RUN_ALL_TESTS();
}