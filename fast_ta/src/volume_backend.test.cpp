#include <cstdlib>

#include "gtest/gtest.h"
#include "testing_common.h"
#include "array_pair.h"

extern "C" {
    #include "volume_backend.h"
}

const double ADI_REF_DOUBLE[data_len] = {
        -13076765.60693842, 12799974.04091093, 28386380.57297606, 41694930.63016835,
        61746609.34287685, 46904600.93122686, 30609117.72880282, 40192737.59755313,
        33773369.35110775, 21082023.12627682,-16236162.36408982,-33791774.99042606,
        -15235067.45055062, 12833678.71098193,-2048285.325506005,-11512965.98698881,
        10044219.60505136, 28615076.81713767, 20905678.46208723, 39724099.07673612,
        58578687.56901424, 48114272.56677595, 50814576.52097984, 65519357.87396045,
        69817179.86745577,   44398991.478074, 57378659.94079952, 38380026.90447353,
        17105876.9870113, 12089828.03808418, 17891838.28215479,-7709400.326378409,
        -16105437.94622484, 12646360.50190996, 4526215.774551369, 23660007.86718853,
        36682110.72101243, 23886409.41237269, 24110738.58611237, 17189313.28768239,
        2988580.676358055, 12055770.59940636, 15473255.02913398, 22790448.55958852,
        10872051.21102067, 13207018.85678189, -12286556.5796233,-22999002.45124349,
        -41097022.3444829,-32073690.28793558,-49420483.08733574,-58436307.91250924,
        -72948213.42087872,-63667496.02860186,-52695024.34403051,-48893491.99277312,
        -46944277.65225675,-30481729.79535183, -20832148.9174893,-40421312.29961865,
        -36511186.39605061,-31526471.46333693,-35468525.45749255,-48335769.22010238,
        -33504108.28436309,-52107980.49875249,-29953101.44795274,-13184323.81372621,
        -5461332.471117435,-16156684.81160704,-25612296.81289501, -22854008.0975012,
        -21782404.29835113,-67121591.99351503,-104967720.2839464,-105137894.3300066,
        -144411151.9507743,-127610001.3840518,-100290786.7587326,-74586171.81042355,
        -75082666.44258818, -76942691.1440632,-55398721.51305193,-88908344.33057505,
        -95528468.90528715,-78889713.81794988,-97516253.39143822,-123690843.1280354,
        -123375710.0983788,-125003956.3582996,-157924860.9128053,-148999014.5594651,
        -168378172.9745184,-154963049.1817088,-138865255.6079797,-139971113.9789335,
        -138520191.085595,-124484370.9086868, -113985679.512243,-118142008.6315689,
        -113921064.8545636,-83146044.36829861,-40634113.06676722,-68696775.92488192,
        -71966415.09626952,-54595538.81908458,-38863205.48826118,-14712207.42491591,
        -29093740.3292227,-78845882.59800982,-79283345.67521261,-104706899.3990124,
        -87525801.02389726,-87436596.28503489,-91570010.44717795,-73954722.50411516,
        -102007182.3610702,-123999625.0928076,-96767021.70553586,-71379418.65037413,
        -83714638.20298018,-110620507.6623578,-105143073.6994723,-83188312.34260531,
        -63864302.48195055,-71249728.98244621,-86151330.54115283,-83434420.46511406,
        -77716639.40891221,-70682981.85381162,-54576842.79313631,-69727609.10463528,
        -51896802.40524261,-48711057.91438054,-31773078.03133658, -11446929.0028191,
        -39995087.18457493,-39919125.64573714, -7523958.27017051, 29029743.26200325,
        47530778.68749511, 44860407.89741278, 59353360.55508387, 63591678.55500488,
        78164179.17205304, 95983343.91880012, 98436310.72300744, 119827791.1535859,
        106193877.4789047, 130883919.0522115, 148089236.2716207, 142179700.0579642,
        141712226.039563, 129165453.3274556, 125955085.5285649, 146209930.8555832,
        140114295.7931668, 154712724.2460245, 158042576.6018749, 141408831.1660113,
        168603935.3859633, 165346968.6693976, 180302179.6383712, 202663947.3533409,
        192501146.6327275,   198031742.70871, 212722669.0767262, 232637801.4624879,
        263742097.1832611, 280143437.2036496, 282546057.5150909, 266477276.5321114,
        265484455.9690212, 226179684.7501736, 247647044.5125966, 252137788.6920443,
        274800746.1652372, 259236434.5508555, 283978843.1910954, 308816773.9258732,
        339556552.7652973, 319652275.9671853, 347935460.7933521, 335202029.2090433,
        356882609.0609058, 383323977.3875003, 381255367.3434126, 410509107.6178008,
        377668062.8661962, 365526976.2471439, 385800259.0236186, 420070498.9256507,
        402820233.6995186, 384771868.8132058, 406481382.0362099, 379809638.0335442,
        387154715.2572361, 418439061.4315951, 413843615.1420658, 442918586.3377749,
        401482164.528536, 407696007.6333342,  432871072.195157, 428729527.2950382,
        454979545.0197476, 447678792.0344662, 475015992.0344662, 459613444.9237998,
        487848361.7093996, 489251280.6422549, 496098083.8258923,  523102667.273995,
        536829981.1638866, 528007001.3805696, 512219543.9397142, 523180624.7036644,
        479225929.9609714, 483228719.2626545, 409961459.2501653, 467776682.1516259,
        534199423.0509582,   485225013.17647, 532976829.5515994,  503481490.294028,
        538917324.7944803, 497349911.5616338, 559480244.5127274, 544324572.3429365,
        441893512.0271183, 521174001.4616076, 459241028.5701323, 500190959.4327757,
        536438097.7730482, 497307124.6850163, 407334968.9288564, 447760084.1179636,
        510946116.8737541, 448321416.9904853, 508887912.6682419,  465821815.176362,
        498072119.6712568, 470324652.6096106, 442623999.7740096, 481895036.3840702,
        472969447.8250279, 518720905.6174794, 471433751.0252793, 495777884.4611965,
        504909853.9258048, 533919579.0227008, 571197895.4615048, 582108362.1281717,
        596852362.8429149
};

float ADI_REF_FLOAT[data_len] = {0};

const double CMF_REF_DOUBLE[data_len] = {
        -0.5088948493539337,0.2344180202059757,0.3602378275482692,0.4244255625866473,
        0.5079454378473188,0.3371954911624401,0.1941644801894051,0.2279864680758614,
        0.170143690077727,0.08603713413761691,-0.05239816125501902,-0.0988475171838393,
        -0.04199880758249654,0.03247445036611705,-0.004720021268259895,-0.0250120758889194,
        0.02028295682262304,0.05334517397981273,0.03520397852178606,0.06301672559212258,
        0.1135185885033078,0.0555827125057764,0.03482476354444269,0.03592328568495721,
        0.01207726828896498,-0.003682268368033321,0.03832766289749587,-0.002576685607659825,
        -0.02350022180398099,-0.01300964314274539,0.05270036173782808,0.0405867340520136,
        -0.001314487621172811,-0.0002835312496926891,0.01008867676090289,0.05429116939986911,
        0.04138671240896583,-0.007521986384334499,0.005358302595183976,-0.03886376648242703,
        -0.09668342386435229,-0.06430973749331342,-0.06514643388565489,-0.0805553489784724,
        -0.1126651625368655,-0.06057234747432218,-0.1323867732606777,-0.1178709861792586,
        -0.1132676724895952,-0.08635148732501775,-0.1316956524119479,-0.09846303972580621,
        -0.1132082874510716,-0.1563567912612461,-0.121834495871369,-0.1562296442592448,
        -0.1821699051670679,-0.1199083293106492,-0.1011365257708334,-0.1290709803984983,
        -0.08931163403360552,-0.09894825114385901,-0.1150829803928104,-0.1653294125570355,
        -0.1037633231440618,-0.1529330156324269,-0.04399481538692614,0.0244331914863591,
        0.0900765082521109,0.04150913431781827,0.06262393572479961,0.09597645091614913,
        0.1355892470603651,-0.008038294087999349,-0.1106625990289543,-0.1134056668094882,
        -0.1863568604516102,-0.1804490174404951,-0.1434980901952126,-0.06094949138819287,
        -0.06795918666799673,-0.07924716893881666,-0.03302722449850135,-0.06482408035450574,
        -0.09774810722242491,-0.04176659926823882,-0.1050161883754018,-0.1695175161309168,
        -0.1790835255610355,-0.1632440373514908,-0.1901109508882285,-0.1801181994291733,
        -0.2117569045449562,-0.1374798274522093,-0.05594453088260872,-0.05942262117209376,
        0.01063687106925053,0.005818504987481884,-0.02595021301039677,-0.08374673002969746,
        -0.07429209361414646,-0.01165862604485241,0.02790230070403863,0.03851046819587624,
        0.0438470656271903,0.04575978227222464,0.1117601545986143,0.2082656303002182,
        0.1799986326062889,0.08287620023389763,0.1485765627587715,0.08287469428285987,
        0.1524145008964972,0.1266030154149075,0.08795301081670769,0.1216741514087721,
        0.06551182430377175,0.0008463123871684315,0.02981756669812086,0.07889433583403739,
        0.05068265523895706,-0.04639636065420449,-0.1138584638173738,-0.02575823459393125,
        0.01435186451957155,-0.02934749041355927,-0.0828157654490481,-0.1218177218164192,
        -0.08698575837092216,0.01546236157096729,0.04656622609788442,0.06727438639125216,
        0.06891443773610498,0.07512393263063633, 0.117593366481106,0.1233693951415808,
        0.1221730487528964,0.1667952460603494,0.1748910318419805,0.1955617415489635,
        0.2580111411439527,0.3105267210779667,0.3283531708616397,0.2956557077137786,
        0.3007462764256984,0.3568766428417092,0.3939053707325791,0.4271857759123308,
        0.3821784858239776,0.4182671246489706,0.4206667221521253,0.4412511885418565,
        0.3968672490629789,0.3551327476266674,0.3161928667836887,0.3180507371403394,
        0.3703750422130323,0.4128212625676962,0.3692948964595291,0.2588354106299071,
        0.2770796259865127,0.2777579385894797,0.2790551740571151,0.3188221649162781,
        0.253676042754387,0.2253369702619204,0.2535683710219487,0.2455828620771899,
        0.3348830727380553,0.3126166072536212, 0.277622034955002,0.2514712802750564,
        0.2514085591310489,0.1827144893233514,0.2256594930837967,0.1997180131953834,
        0.255394883381773, 0.190867971611919,0.2201693374937619,0.2918666054366239,
        0.2953368712968296,0.2577663556110996,0.2749820315480563, 0.217163580179895,
        0.2688943066139567,0.2935342524769523,0.2605970089680344,0.2767248756292276,
        0.1753071803287933,0.1317039093114638,0.1595973480382504,0.2354229767231193,
        0.2095026542250202,0.2591392493791337,0.2589109143278386, 0.200117101906046,
        0.1714829293774741, 0.241515287545207,0.1917640923944844,0.1961425991715637,
        0.08850024368694567,0.1245952053910318,0.1194265309634341,0.1310488561831621,
        0.1387468882935861,0.09274167941242059, 0.136659226966717,0.0722878972719236,
        0.1651302939278342,0.1873366019623495,0.1688422562826077,0.1568369028694849,
        0.2053085992221334,0.2195487702036322,0.1605310306737478,0.2115890225798489,
        0.132519431758266,0.0920660210658225,-0.005319300587881274,0.03088499726952629,
        0.1579380548279886,0.08843431895933382,0.1115601885609157,0.08173976469952925,
        0.0888513105594573,0.0503271541118777,0.08192857138670012,0.07907551066467811,
        -0.04004938032175141,0.02624250879637125,-0.02886158063667017,-0.01735854453749986,
        -0.0002857392782442343,-0.02170684560689733,-0.07075658617794328,-0.04991534940639783,
        0.02079762275969249,-0.02249805037630528,0.06447070017904034,-0.001321951587084589,
        -0.02516848460110977,-0.01060674945012405,-0.06481273134503736,-0.01554491830264935,
        -0.04832847490315843,0.01590879159614619,-0.06656350750768589,-0.03731294343405323,
        0.05094374843312737,0.01082839321665534,0.09776232479950366,0.07468002686760791,
        0.05726237768398287
};

float CMF_REF_FLOAT[data_len] = {0};

const double EMV_REF_DOUBLE[data_len] = {
        -1,  16.9964683916105, 15.76376924937368, 4.079332441678085,
        36.06849637691569, 15.81582155104432,-18.86412205013137,-44.47617954747166,
        12.87591088823537,-33.74110483739194, 103.3071236809168,-26.55797082796284,
        4.970440758362081,-80.07579380517888,-34.76584701668857,-7.905255832464293,
        -62.91415114042297,-49.57391812890733,-111.3453108098466, 16.32394496807655,
        28.70969826366049, 19.45147994024637,-22.97968841907475,-68.67258113332812,
        46.94374331914216,-23.58157472947977,-37.03055639644564, 17.88599518444649,
        -10.83569932955982,-18.52537603746331, 3.317800069807255, -16.1959798251712,
        -45.35528486654896, 52.81194930249309, 76.16372832795045, 10.98001125337297,
        100.9152576389921, 66.50220816219112, 11.62894218577289, -1.69910755252496,
        7.579571064778412,-56.99159049116559, 30.81186269114662, 80.07129189120985,
        10.2804355668407, 8.694327321729698,    1.016728158224,-3.658811112785772,
        -35.61093847744919,     26.4614557015, 13.39733584692605,-18.07344310294079,
        60.37639819223401,-3.396742317693299, 20.33091225136413, 5.366161883339917,
        -48.20355568188511, 3.345769681249784,  30.1302787323027, 5.375513029804366,
        0.5114579543653379, 20.24758343465664,-2.011598524895116,-8.063058018756024,
        7.156348871543916,-7.121125455698696,  16.0867398184301, 23.65340328626168,
        0.7924091491899511,-3.157821072923835, 6.615003660892537,  11.2165294092803,
        -6.760589600323334, 110.4653183394325,-82.55678660225219,-98.14452546482873,
        -97.49200990588783, 4.949683515408231, 10.92454422971015, 73.11422095929223,
        -6.131139778348076,-5.483854321752213, 141.0011022586424,-18.90901950615102,
        -42.39003667261861,   37.202320531245, 65.02922801228611, 5.128185651071655,
        7.52007018712421,-0.4974290567321986,-143.2643698684234,-3.271455539963746,
        -1.649172390054264,-22.88744246755108, 43.97329458566755, 12.83484385198219,
        -44.4537768316811, 31.51940880007398, 44.64561080041565, 7.151781090032869,
        5.702584128395344, 7.817660937356061, 87.42585675865988, 43.30316513948341,
        -54.37398476733317,-0.728764444723073, 10.44022037586712, 15.81201629839002,
        14.13728316546263,-18.83033243946583,-14.51207844830014, 18.60660302084392,
        -10.35098642221759, 6.329971991398166, -11.1044589775637, 52.01198441703379,
        40.71309991439902,  -89.045823507867,-55.22960119197717, 79.49818014013995,
        29.3608252743856,-22.54935691297458, 5.980913730695535, 23.95010248321801,
        78.03475579690566,  20.4527349224539,-1.712243841474528,-22.57987908500841,
        9.572738351118042, 14.85731807091839, 54.17904416409007,   22.008407506683,
        14.06547074477278, 18.55929914305542, 31.43825023272516, 33.32365560489094,
        -36.69420996704266,-38.16653200239693,-1.369630660742121, 167.1832650278792,
        38.93764567358817, 5.991643954286438,-9.221829026210044, 26.42527530982825,
        -12.00300141189714, 35.43671664552563, 12.66805196984512, 15.45601769247239,
        7.044884820829219, 10.00669528098423, 21.18475982452816, 11.85629184172365,
        -73.89121555684815,-6.014504147817591,-8.382153441422709, 46.09564358185789,
        6.201193411982783, 29.71432941542622, 5.495658978196535, -22.3519951913399,
        -89.92549909807178, 63.96720572274302, 39.31756015537951, 67.52915007700902,
        -23.82809912976249, 2.048663443204481, 24.23170677347003, 2.137044593867441,
        41.54481908518397, 68.59957485204626,  14.5690112859978,  2.15642534067182,
        -4.035099218666143, 3.201083064629996, 26.84500403768776, 25.92626628574145,
        77.90614109355319, 59.27336019285175,-43.33300751346635, 43.66093510661436,
        100.5489960468133, 7.193817436890976, -53.2281054540304, 35.62229313278371,
        35.49627926274252, 74.74834893517196, 26.96422637751794,  71.1187569691008,
        10.13630192188202,-45.77579185716944, 18.17805522841284, 32.29350524346914,
        6.974867019376809, 12.00085450211891,-15.64417780837689, 44.72339626148037,
        -205.9250201065685, 106.7190612325204,  111.549148486898,-53.84534166715095,
        -171.1612736412487,-197.6947012969799, 154.4996792336649, 102.0921050470035,
        16.6546446216092,-37.44275741799832,-84.50004389622907, 79.34394702464131,
        61.4788970231354, 5.331237836050657,-5.782220247124321,-97.52258099389476,
        99.29322440022486,-21.90113320618472,-182.9420539229612,-505.1616271457317,
        -67.54129774712132,-49.18478120196496, -206.781922299627,-249.6819944396824,
        616.697347992309, 121.2285724980691,  63.0692978321577,-48.34364882316324,
        -160.3582463100593,-325.8553306912009, 176.1509482351355,-19.99457481034892,
        -368.8447511673362,  216.352733306086,-399.9168792667167,-36.39792261209703,
        -76.27596536158492, 62.69164753406596,-185.3277636215851,-365.4079652314688,
        380.7470025374606, 188.9394077904665, 24.33814108774458,-18.31225223393237,
        14.57349961065961, 101.9168540218683,-289.9553508601416,-57.67371183723672,
        27.15222793341524, 378.5226208650469, 227.9764301742683,-15.26864379793399,
        40.87549311474344, 57.18266072698845, 280.0630673637115, 5.746791948905992,
        31.35556021580375
};

float EMV_REF_FLOAT[data_len] = {0};

const double EMV_SMA_REF_DOUBLE[data_len] = {
        -1,  16.9964683916105, 16.38011882049209, 12.27985669422075,
        18.22701661489449, 17.74477760212445, 11.64329432674848, 3.626226630431321,
        4.782437162656827,0.5020436070958536, 10.78255161447795, 7.387958665165154,
        7.186498839598232,0.4740147899999928,-2.043118196192047,-3.821812783625961,
        -9.441664240040009,-13.27403928079611,-23.80359693699341, -23.7673024072054,
        -20.36917238479169,-15.80291099281184,-18.36402522904827,  -20.859130678758,
        -24.88508641888476,-24.67248669756455,-27.67255792290796,-20.67528728079186,
        -18.96599101742552,-19.72457103206831,-14.99371737419472,-12.60957892392785,
        -7.89600564226374,-5.289719618376844,-1.900146042356132,-2.505250948561375,
        6.344388055586255, 15.99973014812334, 13.47724435288268, 15.04027772266517,
        18.22671539846689, 12.87831642163745, 15.85314228025934, 22.89576141802171,
        23.39309252495267, 25.17097160687416,  28.4832582515008, 24.44963250755231,
        16.46572773573805, 17.57154519631856, 11.32026506831384, 5.279147120804418,
        8.76110826412307, 8.639848638039618, 9.550658722795742, 14.00478389240328,
        8.360825437186724, 2.880430993618148, 4.298276934008291, 4.061218770299338,
        4.025128041452291, 5.732727651983891, 8.132680505737753, 5.666643811433751,
        5.220859027477884,  6.00316743085232,  2.83962040415204, 4.771773661577396,
        3.376166297136383, 2.767310371688971, 6.682921753315946, 7.245118876746697,
        4.610056852987696, 12.11647151796113, 6.183025478202739,-2.273553728903358,
        -9.09358311325998,-8.164101575105391,-7.894944763807803,-2.163848591308451,
        -3.750839991078322,-5.832072677365027, 4.182833973310147, 3.057748370936776,
        -0.4426116528854487, 1.413516284397744, 6.541360399584133,-0.9827205067273559,
        5.451340692513815, 12.42613329309214, 9.156679010053884,  8.56945479181303,
        7.671332176115571,0.8140705027696212,  4.39295867162788, 5.701437112608909,
        -7.54533996527134,-3.943309371969554, 2.273522590390037, 0.127055487446313,
        -4.110561932831599,-3.918456555239856, 1.789099628441263, 4.917713499599522,
        11.26702672110597, 11.44864751362316, 12.31217556833183,  15.0764226230419,
        12.94527895017012, 10.68348064363812, 12.82217338530819, 11.89983011536319,
        7.971501742317956, 7.912801092415478, 6.712298013418404, 9.869035404823956,
        6.532409915948179,-2.921089273148279,-2.982204732051422, 2.748291309724509,
        4.099763088190114, 1.359665001664071,0.7770671848949934, 3.832812536515267,
        10.44330069688711, 10.57516726128783, 11.19222030276947, 9.127230940169001,
        10.60417360650341, 7.950268867495168, 8.912122028187385, 16.84456710065524,
        21.79421509613738, 17.44143788205992, 17.58982537908417, 21.58075484464599,
        18.53253172337898, 14.09562926012077, 8.423887370288785, 18.90463952067631,
        21.8082030574665, 23.84902613170184, 22.50655703332126,  23.3328396932434,
        18.60555072353003, 19.56471566201879, 19.46490003523824, 19.24323707448232,
        17.50085383077546, 15.83535666478213, 19.96956879275147, 23.54262763876008,
        18.36251443189537, 5.991245205059879, 2.611259553987674, 5.475830955957063,
        6.577475415827979,  6.81240785194212,  8.06231216552024, 3.934547034315558,
        -3.393563756249935,0.07152110305510995,  2.37671219838013, 6.485458969524758,
        3.270254758503996, 2.569709872895484, 9.578490039346784, 10.16074352089572,
        13.72695584422476, 15.33437950638107, 15.93208078309643, 13.96365906347112,
        13.28289062083807, 15.10811049626449, 23.44886072024731, 20.73165076046149,
        23.48797797033103, 22.89827869289123,  21.5050709511981, 24.47737607001309,
        29.92861101810903,   30.289809078325, 23.52031446838112, 21.16479434557665,
        22.65959920105842, 27.84473660066557, 30.05897414325014, 34.91023656499806,
        33.71675784244051, 28.59518226080401, 24.32889041329399, 22.40175791690952,
        25.99517752639832, 23.73374319750578, 15.43423077927791,  18.1149149810343,
        7.207992505853007, 12.28633308440563, 17.71868088613102, 8.533417271679387,
        -5.618404158232515,-24.81936546295256,-14.50769565496807,-3.945703018955723,
        -4.05451806229884,-9.035679680975088,-15.56960188923265,-10.75938099476676,
        -5.250589935373028,-8.064315537189435, 6.231598738485149, -8.35708999197308,
        -9.232513141021164,-6.950783965237861,-7.792268271074464, -29.7541915459853,
        -45.61426133032717,-56.41975320525349,-72.37950798534179,-87.53945348689065,
        -37.45392549485221,-34.46216653246452,-34.34856647467721,-38.18248695033534,
        -49.22363166911641,-65.53311379035256,-60.04327637357323,-59.90709363101353,
        -73.18585771989747,-21.64911768762477,-45.39023065331016,-44.47688361117674,
        -35.15502954417374,-12.84262654604885,-70.13013451846986,-104.8898872134369,
        -82.1986225916295, -65.2498328335131,-52.05723373366997,-30.08987098672221,
        -41.63111731704191,-32.92315811474068,-27.28820094994106, -46.8615184601784,
        -16.35658223159754, 13.28059944534131, 35.01291341218796, 29.44432117418797,
        45.6016966553543, 75.78674136667267, 68.59503171140489, 55.50984486557913,
        56.01108908901193
};

float EMV_SMA_REF_FLOAT[data_len] = {0};

TEST(momentum_backend, ADIDouble) {
    double* out = _ADI_DOUBLE(SAMPLE_HIGH_DOUBLE, SAMPLE_LOW_DOUBLE, SAMPLE_CLOSE_DOUBLE, SAMPLE_VOLUME_DOUBLE, data_len);
    for (int i=0; i<data_len; i++) {
        ASSERT_DOUBLE_EQ(ADI_REF_DOUBLE[i], out[i]);
    }

    free(out);
}

TEST(momentum_backend, ADIFloat) {
    float* out = _ADI_FLOAT(SAMPLE_HIGH_FLOAT, SAMPLE_LOW_FLOAT, SAMPLE_CLOSE_FLOAT, SAMPLE_VOLUME_FLOAT, data_len);
    double max_fp_error = get_max_fp_error(ADI_REF_DOUBLE, data_len);
    for (int i=0; i<data_len; i++) {
        ASSERT_NEAR(ADI_REF_FLOAT[i], out[i], max_fp_error);
    }

    free(out);
}

TEST(momentum_backend, CMFDouble) {
    double* out = _CMF_DOUBLE(SAMPLE_HIGH_DOUBLE, SAMPLE_LOW_DOUBLE, SAMPLE_CLOSE_DOUBLE, SAMPLE_VOLUME_DOUBLE, data_len, 20);
    for (int i=0; i<data_len; i++) {
        ASSERT_DOUBLE_EQ(CMF_REF_DOUBLE[i], out[i]);
    }

    free(out);
}

TEST(momentum_backend, CMFFloat) {
    float* out = _CMF_FLOAT(SAMPLE_HIGH_FLOAT, SAMPLE_LOW_FLOAT, SAMPLE_CLOSE_FLOAT, SAMPLE_VOLUME_FLOAT, data_len, 20);
    double max_fp_error = get_max_fp_error(CMF_REF_DOUBLE, data_len);
    for (int i=0; i<data_len; i++) {
        ASSERT_NEAR(CMF_REF_FLOAT[i], out[i], max_fp_error);
    }

    free(out);
}

TEST(momentum_backend, EMVDouble) {
    struct double_array_pair out = _EMV_DOUBLE(SAMPLE_HIGH_DOUBLE, SAMPLE_LOW_DOUBLE, SAMPLE_VOLUME_DOUBLE, data_len, 14);
    for (int i=1; i<data_len; i++) {
        ASSERT_DOUBLE_EQ(EMV_REF_DOUBLE[i], out.arr1[i]);
        ASSERT_DOUBLE_EQ(EMV_SMA_REF_DOUBLE[i], out.arr2[i]);
    }

    free(out.arr1);
    free(out.arr2);
}

TEST(momentum_backend, EMVFloat) {
    struct float_array_pair out = _EMV_FLOAT(SAMPLE_HIGH_FLOAT, SAMPLE_LOW_FLOAT, SAMPLE_VOLUME_FLOAT, data_len, 14);
    double max_fp_error1 = get_max_fp_error(EMV_REF_DOUBLE, data_len);
    double max_fp_error2 = get_max_fp_error(EMV_SMA_REF_DOUBLE, data_len);
    for (int i=1; i<data_len; i++) {
        ASSERT_NEAR(EMV_REF_FLOAT[i], out.arr1[i], max_fp_error1);
        ASSERT_NEAR(EMV_SMA_REF_FLOAT[i], out.arr2[i], max_fp_error2);
    }

    free(out.arr1);
    free(out.arr2);
}

int main(int argc, char* argv[]) {
    populate_float_arrays();
    for (int i=0; i<data_len; i++) {
        ADI_REF_FLOAT[i] = (float)ADI_REF_DOUBLE[i];
    }
    for (int i=0; i<data_len; i++) {
        CMF_REF_FLOAT[i] = (float)CMF_REF_DOUBLE[i];
    }
    for (int i=0; i<data_len; i++) {
        EMV_REF_FLOAT[i] = (float)EMV_REF_DOUBLE[i];
    }
    for (int i=0; i<data_len; i++) {
        EMV_SMA_REF_FLOAT[i] = (float)EMV_SMA_REF_DOUBLE[i];
    }
    testing::InitGoogleTest(&argc, argv);
    return RUN_ALL_TESTS();
}